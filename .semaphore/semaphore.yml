version: "v1.0"
name: "certbot-ocsp-fetcher"
agent:
  machine:
    type: "e1-standard-2"
    os_image: "ubuntu1804"

global_job_config:
  env_vars:
    - name: "TMPDIR"
      value: "/tmp"
  prologue:
    commands:
      - "checkout --use-cache"

blocks:
  - name: "Linting, formatting, tests"
    task:
      jobs:
        - name: "Install ShellCheck and lint shell code"
          commands:
            - "tar
                --extract
                --directory \"${TMPDIR}\"
                --strip-components 1
                --xz
                --file
                <(curl
                  --fail
                  --location
                  --silent
                  --show-error
                  https://github.com/koalaman/shellcheck/releases/download/stable/shellcheck-stable.linux.x86_64.tar.xz)
                shellcheck-stable/shellcheck"

            - "(shopt -s nullglob &&
              \"${TMPDIR}/shellcheck\" --enable all
              ./certbot-ocsp-fetcher ./*.sh)"

            # We need to exclude SC2154 because of
            # https://github.com/koalaman/shellcheck/issues/1823
            - "\"${TMPDIR}/shellcheck\" --enable all --exclude 2154 tests/*.{bash,bats}"

        - name: "Install shfmt and check shell code formatting"
          commands:
            - "curl
                --fail
                --location
                --silent
                --show-error
                https://github.com/mvdan/sh/releases/download/v3.1.2/shfmt_v3.1.2_linux_amd64 \
              -o \"${TMPDIR}/shfmt\""
            - "chmod +x \"${TMPDIR}/shfmt\""

            - "\"${TMPDIR}/shfmt\" -d -s ."

        - name: "Install Bats and run tests"
          commands:
            - "sudo apt install bats"
            - "bats ./tests"
